<div class="trip-history-container">
  <div class="header">
    <h2>📋 Trip History</h2>
    <p>View and manage your completed rides</p>
  </div>

  <!-- Loading and Error States -->
  <div class="loading-spinner" *ngIf="isLoading">
    <p>Loading your trips...</p>
  </div>

  <div class="error-message" *ngIf="errorMessage && !isLoading">
    <p>{{ errorMessage }}</p>
    <button (click)="loadTripHistory()">Try Again</button>
  </div>

  <!-- Filters and Search -->
  <div class="controls-section" *ngIf="!isLoading">
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="searchTerm" 
        (input)="onSearchChange()"
        placeholder="Search trips, locations, or drivers..."
        class="search-input">
      <span class="search-icon">🔍</span>
    </div>
    
    <div class="filters">
      <select [(ngModel)]="filterStatus" (change)="onFilterChange()" class="filter-select">
        <option value="all">All Status</option>
        <option value="completed">Completed</option>
        <option value="ongoing">Ongoing</option>
        <option value="confirmed">Confirmed</option>
        <option value="cancelled">Cancelled</option>
      </select>
      
      <select [(ngModel)]="sortBy" (change)="onSortChange()" class="filter-select">
        <option value="date">Sort by Date</option>
        <option value="fare">Sort by Fare</option>
        <option value="rating">Sort by Rating</option>
      </select>
    </div>
  </div>

  <!-- Trip List -->
  <div class="trips-list" *ngIf="filteredTrips.length > 0 && !isLoading">
    <div class="trip-card" 
         *ngFor="let trip of filteredTrips" 
         (click)="viewTripDetails(trip)">
      <div class="trip-header">
        <div class="trip-id">Trip #{{trip.tripBookingId}}</div>
        <div class="trip-status" [ngClass]="getStatusClass(trip.status)">
          <span class="status-icon">{{getStatusIcon(trip.status)}}</span>
          <span class="status-text">{{getStatusDisplayText(trip.status)}}</span>
        </div>
      </div>
      
      <div class="trip-route">
        <div class="route-point pickup">
          <span class="route-icon">🟢</span>
          <span class="route-text">{{trip.fromLocation}}</span>
        </div>
        <div class="route-line"></div>
        <div class="route-point destination">
          <span class="route-icon">🔴</span>
          <span class="route-text">{{trip.toLocation}}</span>
        </div>
      </div>
      
      <div class="trip-details">
        <div class="detail-item">
          <span class="detail-label">Date</span>
          <span class="detail-value">{{formatDate(trip.fromDateTime)}}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Time</span>
          <span class="detail-value">{{formatTime(trip.fromDateTime)}}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Driver</span>
          <span class="detail-value">{{trip.driver.username}}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Fare</span>
          <span class="detail-value" [class.cancelled-fare]="trip.status === 'CANCELLED'">
            {{trip.status === 'CANCELLED' ? 'N/A' : '$' + trip.bill}}
          </span>
        </div>
      </div>
      
      <div class="trip-rating" *ngIf="trip.status === 'COMPLETED'">
        <div class="rating" *ngIf="trip.customerRating">
          <span *ngFor="let star of getStarArray(trip.customerRating)" 
                class="star filled">★</span>
          <span class="rating-text">{{trip.customerRating}}/5</span>
        </div>
        <button class="rate-btn" 
                *ngIf="!trip.customerRating" 
                (click)="openRatingModal(trip); $event.stopPropagation()">
          Rate Trip
        </button>
      </div>
    </div>
  </div>

  <!-- No Results -->
  <div class="no-results" *ngIf="filteredTrips.length === 0 && !isLoading">
    <div class="no-results-icon">🚗💭</div>
    <h3>No trips found</h3>
    <p>Try adjusting your search or filter criteria</p>
  </div>

  <!-- Trip Details Modal -->
  <div class="modal-overlay" *ngIf="selectedTrip" (click)="closeTripDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Trip Details</h3>
        <button class="close-btn" (click)="closeTripDetails()">✕</button>
      </div>
      
      <div class="modal-body">
        <div class="trip-info-section">
          <h4>📍 Route Information</h4>
          <div class="route-details">
            <p><strong>From:</strong> {{selectedTrip.fromLocation}}</p>
            <p><strong>To:</strong> {{selectedTrip.toLocation}}</p>
            <p><strong>Distance:</strong> {{selectedTrip.distanceInKm}} km</p>
            <p><strong>Booked at:</strong> {{formatDateTime(selectedTrip.fromDateTime)}}</p>
            <p *ngIf="selectedTrip.toDateTime"><strong>Completed at:</strong> {{formatDateTime(selectedTrip.toDateTime)}}</p>
          </div>
        </div>
        
        <div class="trip-info-section">
          <h4>👨‍💼 Driver Information</h4>
          <div class="driver-details">
            <div class="driver-avatar">
              <img [src]="rideService.getDriverImage(selectedTrip.driver)" [alt]="selectedTrip.driver.username" 
                   onerror="this.src='assets/images/driver.avif'">
            </div>
            <div class="driver-info">
              <p><strong>{{selectedTrip.driver.username}}</strong></p>
              <div class="rating">
                <span *ngFor="let star of getStarArray(selectedTrip.driver.rating)" 
                      class="star filled">★</span>
                <span class="rating-text">{{selectedTrip.driver.rating}}</span>
              </div>
              <p>{{selectedTrip.cab.carType}} • {{selectedTrip.cab.numberPlate}}</p>
              <p>License: {{selectedTrip.driver.licenceNo}}</p>
            </div>
          </div>
        </div>
        
        <div class="trip-info-section">
          <h4>💰 Payment Information</h4>
          <div class="payment-details">
            <p><strong>Fare:</strong> 
              <span [class.cancelled-fare]="selectedTrip.status === 'CANCELLED'">
                {{selectedTrip.status === 'CANCELLED' ? 'N/A' : '$' + selectedTrip.bill}}
              </span>
            </p>
            <p><strong>Distance:</strong> {{selectedTrip.distanceInKm}} km</p>
            <p><strong>Trip Date:</strong> {{formatDate(selectedTrip.fromDateTime)}} at {{formatTime(selectedTrip.fromDateTime)}}</p>
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="action-btn secondary" (click)="rebookTrip(selectedTrip)">
          🔄 Rebook
        </button>
        <button class="action-btn primary" (click)="callDriver(selectedTrip)" 
                [disabled]="!selectedTrip.driver.mobileNumber">
          📞 Call Driver
        </button>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <div class="modal-overlay" *ngIf="showRatingModal" (click)="closeRatingModal()">
    <div class="modal-content rating-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Rate Your Trip</h3>
        <button class="close-btn" (click)="closeRatingModal()">✕</button>
      </div>
      
      <div class="modal-body" *ngIf="ratingTrip">
        <div class="rating-driver">
          <div class="driver-avatar">
            <img [src]="rideService.getDriverImage(ratingTrip.driver)" [alt]="ratingTrip.driver.username"
                 onerror="this.src='assets/images/driver.avif'">
          </div>
          <h4>{{ratingTrip.driver.username}}</h4>
          <p>{{ratingTrip.cab.carType}}</p>
        </div>
        
        <div class="rating-stars">
          <span *ngFor="let star of [1,2,3,4,5]; let i = index"
                class="rating-star"
                [class.active]="i < currentRating"
                (click)="setRating(i + 1)">★</span>
        </div>
        
        <div class="rating-text">
          <span *ngIf="currentRating === 0">Tap stars to rate</span>
          <span *ngIf="currentRating === 1">Poor</span>
          <span *ngIf="currentRating === 2">Fair</span>
          <span *ngIf="currentRating === 3">Good</span>
          <span *ngIf="currentRating === 4">Very Good</span>
          <span *ngIf="currentRating === 5">Excellent</span>
        </div>
      </div>
      
      <div class="modal-actions">
        <button class="action-btn secondary" (click)="closeRatingModal()">Cancel</button>
        <button class="action-btn primary" 
                [disabled]="currentRating === 0"
                (click)="submitRating()">
          Submit Rating
        </button>
      </div>
    </div>
  </div>
</div>